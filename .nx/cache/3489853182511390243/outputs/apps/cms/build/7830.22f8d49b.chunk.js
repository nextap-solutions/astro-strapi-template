(self.webpackChunkcms=self.webpackChunkcms||[]).push([[7830,580],{93841:h=>{function I(s,t,c,_){for(var E=c-1,P=s.length;++E<P;)if(_(s[E],t))return E;return-1}h.exports=I},31583:(h,I,s)=>{var t=s(5316),c=s(91308),_=s(93841),E=s(39788),P=s(41645),R=Array.prototype,T=R.splice;function K(u,x,W,Z){var z=Z?_:c,$=-1,V=x.length,r=u;for(u===x&&(x=P(x)),W&&(r=t(u,E(W)));++$<V;)for(var f=0,F=x[$],L=W?W(F):F;(f=z(r,L,f,Z))>-1;)r!==u&&T.call(r,f,1),T.call(u,f,1);return u}h.exports=K},78181:(h,I,s)=>{var t=s(5316),c=s(67008),_=s(1191),E=s(7405);function P(R,T){var K=E(R)?t:_;return K(R,c(T,3))}h.exports=P},1843:(h,I,s)=>{var t=s(39416),c=s(25847),_=t(c);h.exports=_},25847:(h,I,s)=>{var t=s(31583);function c(_,E){return _&&_.length&&E&&E.length?t(_,E):_}h.exports=c},89896:(h,I,s)=>{var t=s(64594);function c(_){var E=_==null?0:_.length;return E?t(_,1,E):[]}h.exports=c},97830:(h,I,s)=>{"use strict";s.d(I,{ProtectedCreateView:()=>cs});var t=s(91320),c=s(6264),_=s(5676),E=s(79377),P=s(60580),R=s(38239),T=s(54769),K=s(98297),u=s(69158),x=s(51896),W=s(85904),Z=s(70644),z=s(39112),$=s(32805),V=s(84770),r=s(67652),f=s(13768),F=s(99321),L=s(90217),J=s(76350),b=s(22310),Q=s(96110),w=s(76251),as=s(21977),G=s(49470),y=s(17141),os=s(21681),is=s(38506),ls=s(99135),_s=s(52800),ds=s(62643),H=s(2863),Es=s(4626),j=s(50589),rs=s(77315),q=s(89775),As=s(56302),hs=s(75376),Ts=s(50024),ms=s(92585),gs=s(64706),Cs=s(98064),vs=s(87282),ps=s(10112),Is=s(13406),Ls=s(35577),Rs=s(73607),us=s(38243),Us=s(23889),Bs=s(18334),xs=s(7405),Ws=s(74261),Ks=s(78181),fs=s(89896),ys=s(91907),js=s(1843);const cs=()=>{const Ps=(0,_.v9)(E.s);return(0,t.jsx)(c.O4,{permissions:Ps.settings?.["api-tokens"].create,children:(0,t.jsx)(P.N,{})})}},60580:(h,I,s)=>{"use strict";s.d(I,{N:()=>Ms,ProtectedEditView:()=>nt});var t=s(91320),c=s(38239),_=s(92422),E=s(65676),P=s(70946),R=s(2548),T=s(64150),K=s(20674),u=s(64062),x=s(70269),W=s(44137),Z=s(58095),z=s(86811),$=s(46432),V=s(39160),r=s(6264),f=s(58686),F=s(13768),L=s(67645),J=s(54769),b=s(5676),Q=s(71179),w=s(79377),as=s(6814),G=s(73047),y=s(74261),os=s(5087),is=s(84749),ls=s(37146),_s=s(78181),ds=s(89896),H=s(9714),Es=s(91907),j=s(90217),rs=s(9271),q=s(1843),As=s(98297),hs=s(69158),Ts=s(51896),ms=s(85904),gs=s(70644),Cs=s(39112),vs=s(32805),ps=s(84770),Is=s(67652),Ls=s(99321),Rs=s(76350),us=s(22310),Us=s(96110),Bs=s(76251),xs=s(21977),Ws=s(49470),Ks=s(17141),fs=s(21681),ys=s(38506),js=s(99135),cs=s(52800),Ps=s(62643),dt=s(2863),Et=s(4626),rt=s(50589),ct=s(77315),Pt=s(89775),Ot=s(56302),Mt=s(75376),Dt=s(50024),At=s(92585),ht=s(64706),Tt=s(98064),mt=s(87282),gt=s(10112),Ct=s(13406),vt=s(35577),pt=s(73607),It=s(38243),Lt=s(23889),Rt=s(18334),ut=s(7405);const[Ss,Ns]=(0,os.k)("ApiTokenPermissionsContext"),Zs=({children:n,...a})=>(0,t.jsx)(Ss,{...a,children:n}),ss=()=>Ns("useApiTokenPermissions"),$s=({errors:n={},onChange:a,canEditInputs:e,isCreating:d,values:o={},apiToken:O={},onDispatch:i,setHasChangedPermissions:U})=>{const{formatMessage:D}=(0,L.Z)(),B=({target:{value:v}})=>{U(!1),v==="full-access"&&i({type:"SELECT_ALL_ACTIONS"}),v==="read-only"&&i({type:"ON_CHANGE_READ_ONLY"})},k=[{value:"read-only",label:{id:"Settings.tokens.types.read-only",defaultMessage:"Read-only"}},{value:"full-access",label:{id:"Settings.tokens.types.full-access",defaultMessage:"Full access"}},{value:"custom",label:{id:"Settings.tokens.types.custom",defaultMessage:"Custom"}}];return(0,t.jsx)(_.x,{background:"neutral0",hasRadius:!0,shadow:"filterShadow",paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,children:(0,t.jsxs)(E.k,{direction:"column",alignItems:"stretch",gap:4,children:[(0,t.jsx)(P.Z,{variant:"delta",as:"h2",children:D({id:"global.details",defaultMessage:"Details"})}),(0,t.jsxs)(R.r,{gap:5,children:[(0,t.jsx)(T.P,{col:6,xs:12,children:(0,t.jsx)(y.T,{error:n.name,value:o.name,canEditInputs:e,onChange:a})},"name"),(0,t.jsx)(T.P,{col:6,xs:12,children:(0,t.jsx)(y.a,{error:n.description,value:o.description,canEditInputs:e,onChange:a})},"description"),(0,t.jsx)(T.P,{col:6,xs:12,children:(0,t.jsx)(y.L,{isCreating:d,error:n.lifespan,value:o.lifespan,onChange:a,token:O})},"lifespan"),(0,t.jsx)(T.P,{col:6,xs:12,children:(0,t.jsx)(y.b,{value:o.type,error:n.type,label:{id:"Settings.tokens.form.type",defaultMessage:"Token type"},onChange:v=>{B({target:{value:v}}),a({target:{name:"type",value:v}})},options:k,canEditInputs:e})},"type")]})]})})},Vs=({apiTokenName:n=null})=>{const{formatMessage:a}=(0,L.Z)();return(0,r.go)(),(0,t.jsxs)(K.o,{"aria-busy":"true",children:[(0,t.jsx)(r.SL,{name:"API Tokens"}),(0,t.jsx)(u.T,{primaryAction:(0,t.jsx)(x.z,{disabled:!0,startIcon:(0,t.jsx)(is.Z,{}),type:"button",size:"L",children:a({id:"global.save",defaultMessage:"Save"})}),title:n||a({id:"Settings.apiTokens.createPage.title",defaultMessage:"Create API Token"})}),(0,t.jsx)(W.D,{children:(0,t.jsx)(r.dO,{})})]})},Fs=n=>{switch(n){case"POST":return{text:"success600",border:"success200",background:"success100"};case"GET":return{text:"secondary600",border:"secondary200",background:"secondary100"};case"PUT":return{text:"warning600",border:"warning200",background:"warning100"};case"DELETE":return{text:"danger600",border:"danger200",background:"danger100"};default:return{text:"neutral600",border:"neutral200",background:"neutral100"}}},Gs=(0,H.ZP)(_.x)`
  margin: -1px;
  border-radius: ${({theme:n})=>n.spaces[1]} 0 0 ${({theme:n})=>n.spaces[1]};
`,Hs=({route:n={handler:"Nocontroller.error",method:"GET",path:"/there-is-no-path"}})=>{const{formatMessage:a}=(0,L.Z)(),{method:e,handler:d,path:o}=n,O=o?ds(o.split("/")):[],[i="",U=""]=d?d.split("."):[],D=Fs(n.method);return(0,t.jsxs)(E.k,{direction:"column",alignItems:"stretch",gap:2,children:[(0,t.jsxs)(P.Z,{variant:"delta",as:"h3",children:[a({id:"Settings.apiTokens.createPage.BoundRoute.title",defaultMessage:"Bound route to"}),"\xA0",(0,t.jsx)("span",{children:i}),(0,t.jsxs)(P.Z,{variant:"delta",textColor:"primary600",children:[".",U]})]}),(0,t.jsxs)(E.k,{hasRadius:!0,background:"neutral0",borderColor:"neutral200",gap:0,children:[(0,t.jsx)(Gs,{background:D.background,borderColor:D.border,padding:2,children:(0,t.jsx)(P.Z,{fontWeight:"bold",textColor:D.text,children:e})}),(0,t.jsx)(_.x,{paddingLeft:2,paddingRight:2,children:_s(O,B=>(0,t.jsxs)(P.Z,{textColor:B.includes(":")?"neutral600":"neutral900",children:["/",B]},B))})]})]})},ks=()=>{const{value:{selectedAction:n,routes:a}}=ss(),{formatMessage:e}=(0,L.Z)(),d=n?.split(".")[0];return(0,t.jsx)(T.P,{col:5,background:"neutral150",paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,style:{minHeight:"100%"},children:n?(0,t.jsx)(E.k,{direction:"column",alignItems:"stretch",gap:2,children:d&&d in a&&a[d].map(o=>o.config.auth?.scope?.includes(n)||o.handler===n?(0,t.jsx)(Hs,{route:o},o.handler):null)}):(0,t.jsxs)(E.k,{direction:"column",alignItems:"stretch",gap:2,children:[(0,t.jsx)(P.Z,{variant:"delta",as:"h3",children:e({id:"Settings.apiTokens.createPage.permissions.header.title",defaultMessage:"Advanced settings"})}),(0,t.jsx)(P.Z,{as:"p",textColor:"neutral600",children:e({id:"Settings.apiTokens.createPage.permissions.header.hint",defaultMessage:"Select the application's actions or the plugin's actions and click on the cog icon to display the bound route"})})]})})},Os=(0,H.iv)`
  background: ${n=>n.theme.colors.primary100};
  svg {
    opacity: 1;
  }
`,Ys=(0,H.ZP)(_.x)`
  display: flex;
  justify-content: space-between;
  align-items: center;

  svg {
    opacity: 0;
    path {
      fill: ${n=>n.theme.colors.primary600};
    }
  }

  /* Show active style both on hover and when the action is selected */
  ${n=>n.isActive&&Os}
  &:hover {
    ${Os}
  }
`,zs=H.ZP.div`
  flex: 1;
  align-self: center;
  border-top: 1px solid ${({theme:n})=>n.colors.neutral150};
`,Qs=({controllers:n=[],label:a,orderNumber:e=0,disabled:d=!1,onExpanded:o=()=>null,indexExpandendCollapsedContent:O=null})=>{const{value:{onChangeSelectAll:i,onChange:U,selectedActions:D,setSelectedAction:B,selectedAction:k}}=ss(),[v,X]=c.useState(!1),{formatMessage:Y}=(0,L.Z)(),A=()=>{X(M=>!M),o(e)};c.useEffect(()=>{O!==null&&O!==e&&v&&X(!1)},[O,e,v]);const Ds=M=>M===k;return(0,t.jsxs)(Z.U,{expanded:v,onToggle:A,variant:e%2?"primary":"secondary",children:[(0,t.jsx)(z.B,{title:Es(a)}),(0,t.jsx)($.v,{children:n?.map(M=>{const S=M.actions.every(m=>D.includes(m.actionId)),ts=M.actions.some(m=>D.includes(m.actionId));return(0,t.jsxs)(_.x,{children:[(0,t.jsxs)(E.k,{justifyContent:"space-between",alignItems:"center",padding:4,children:[(0,t.jsx)(_.x,{paddingRight:4,children:(0,t.jsx)(P.Z,{variant:"sigma",textColor:"neutral600",children:M?.controller})}),(0,t.jsx)(zs,{}),(0,t.jsx)(_.x,{paddingLeft:4,children:(0,t.jsx)(V.X,{value:S,indeterminate:!S&&ts,onValueChange:()=>{i({target:{value:[...M.actions]}})},disabled:d,children:Y({id:"app.utils.select-all",defaultMessage:"Select all"})})})]}),(0,t.jsx)(R.r,{gap:4,padding:4,children:M?.actions&&M?.actions.map(m=>(0,t.jsx)(T.P,{col:6,children:(0,t.jsxs)(Ys,{isActive:Ds(m.actionId),padding:2,hasRadius:!0,children:[(0,t.jsx)(V.X,{value:D.includes(m.actionId),name:m.actionId,onValueChange:()=>{U({target:{value:m.actionId}})},disabled:d,children:m.action}),(0,t.jsx)("button",{type:"button","data-testid":"action-cog",onClick:()=>B({target:{value:m.actionId}}),style:{display:"inline-flex",alignItems:"center"},children:(0,t.jsx)(ls.Z,{})})]})},m.actionId))})]},`${a}.${M?.controller}`)})})]})},Xs=({section:n=null,...a})=>{const[e,d]=c.useState(null),o=O=>d(O);return(0,t.jsx)(_.x,{padding:4,background:"neutral0",children:n&&n.map((O,i)=>(0,t.jsx)(Qs,{label:O.label,controllers:O.controllers,orderNumber:i,indexExpandendCollapsedContent:e,onExpanded:o,...a},O.apiId))})},Js=({...n})=>{const{value:{data:a}}=ss(),{formatMessage:e}=(0,L.Z)();return(0,t.jsxs)(R.r,{gap:0,shadow:"filterShadow",hasRadius:!0,background:"neutral0",children:[(0,t.jsxs)(T.P,{col:7,paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,children:[(0,t.jsxs)(E.k,{direction:"column",alignItems:"stretch",gap:2,children:[(0,t.jsx)(P.Z,{variant:"delta",as:"h2",children:e({id:"Settings.apiTokens.createPage.permissions.title",defaultMessage:"Permissions"})}),(0,t.jsx)(P.Z,{as:"p",textColor:"neutral600",children:e({id:"Settings.apiTokens.createPage.permissions.description",defaultMessage:"Only actions bound by a route are listed below."})})]}),a?.permissions&&(0,t.jsx)(Xs,{section:a?.permissions,...n})]}),(0,t.jsx)(ks,{})]})},bs=j.Ry().shape({name:j.Z_().max(100).required(r.I0.required),type:j.Z_().oneOf(["read-only","full-access","custom"]).required(r.I0.required),description:j.Z_().nullable(),lifespan:j.Rx().integer().min(0).nullable().defined(r.I0.required)}),ws=n=>{const a={allActionsIds:[],permissions:[]};return a.permissions=Object.entries(n).map(([e,d])=>({apiId:e,label:e.split("::")[1],controllers:Object.keys(d.controllers).map(o=>({controller:o,actions:o in d.controllers?d.controllers[o].map(O=>{const i=`${e}.${o}.${O}`;return e.includes("api::")&&a.allActionsIds.push(i),{action:O,actionId:i}}).flat():[]})).flat()})),a},qs={data:{allActionsIds:[],permissions:[]},routes:{},selectedAction:"",selectedActions:[]},st=(n,a)=>(0,rs.ZP)(n,e=>{switch(a.type){case"ON_CHANGE":{e.selectedActions.includes(a.value)?q(e.selectedActions,a.value):e.selectedActions.push(a.value);break}case"SELECT_ALL_IN_PERMISSION":{a.value.every(o=>e.selectedActions.includes(o.actionId))?a.value.forEach(o=>{q(e.selectedActions,o.actionId)}):a.value.forEach(o=>{e.selectedActions.push(o.actionId)});break}case"SELECT_ALL_ACTIONS":{e.selectedActions=[...e.data.allActionsIds];break}case"ON_CHANGE_READ_ONLY":{const d=e.data.allActionsIds.filter(o=>o.includes("find")||o.includes("findOne"));e.selectedActions=[...d];break}case"UPDATE_PERMISSIONS_LAYOUT":{e.data=ws(a.value);break}case"UPDATE_ROUTES":{e.routes={...a.value};break}case"UPDATE_PERMISSIONS":{e.selectedActions=[...a.value];break}case"SET_SELECTED_ACTION":{e.selectedAction=a.value;break}default:return e}}),tt="Name already taken",Ms=()=>{(0,r.go)();const{formatMessage:n}=(0,L.Z)(),{lockApp:a,unlockApp:e}=(0,r.o1)(),d=(0,r.lm)(),{state:o}=(0,Q.TH)(),O=(0,b.v9)(w.s),[i,U]=c.useState(o?.apiToken?.accessKey?{...o.apiToken}:null),{trackUsage:D}=(0,r.rS)(),{setCurrentStep:B}=(0,r.c1)(),{allowedActions:{canCreate:k,canUpdate:v,canRegenerate:X}}=(0,r.ss)(O.settings?.["api-tokens"]),[Y,A]=c.useReducer(st,qs),M=(0,Q.$B)("/settings/api-tokens/:id")?.params?.id,{get:S,post:ts,put:m}=(0,r.kY)(),et=(0,Q.k6)(),g=M==="create";(0,J.useQuery)("content-api-permissions",async()=>{await Promise.all(["/admin/content-api/permissions","/admin/content-api/routes"].map(async l=>{if(l==="/admin/content-api/permissions"){const{data:{data:p}}=await S(l);return A({type:"UPDATE_PERMISSIONS_LAYOUT",value:p}),p}else if(l==="/admin/content-api/routes"){const{data:{data:p}}=await S(l);return A({type:"UPDATE_ROUTES",value:p}),p}})),i&&(i?.type==="read-only"&&A({type:"ON_CHANGE_READ_ONLY"}),i?.type==="full-access"&&A({type:"SELECT_ALL_ACTIONS"}),i?.type==="custom"&&A({type:"UPDATE_PERMISSIONS",value:i?.permissions}))},{onError(){d({type:"warning",message:{id:"notification.error",defaultMessage:"An error occured"}})}}),c.useEffect(()=>{D(g?"didAddTokenFromList":"didEditTokenFromList",{tokenType:G.A})},[g,D]);const{status:at}=(0,J.useQuery)(["api-token",M],async()=>{const{data:{data:l}}=await S(`/admin/api-tokens/${M}`);return U({...l}),l?.type==="read-only"&&A({type:"ON_CHANGE_READ_ONLY"}),l?.type==="full-access"&&A({type:"SELECT_ALL_ACTIONS"}),l?.type==="custom"&&A({type:"UPDATE_PERMISSIONS",value:l?.permissions}),l},{enabled:!g&&!i,onError(){d({type:"warning",message:{id:"notification.error",defaultMessage:"An error occured"}})}}),ot=async(l,p)=>{D(g?"willCreateToken":"willEditToken",{tokenType:G.A}),a();try{const{data:{data:C}}=g?await ts("/admin/api-tokens",{...l,lifespan:l.lifespan==="0"?parseInt(l.lifespan):null,permissions:l.type==="custom"?Y.selectedActions:null}):await m(`/admin/api-tokens/${M}`,{name:l.name,description:l.description,type:l.type,permissions:l.type==="custom"?Y.selectedActions:null});g&&(et.replace(`/settings/api-tokens/${C.id}`,{apiToken:C}),B("apiTokens.success")),e(),U({...C}),d({type:"success",message:n(g?{id:"notification.success.apitokencreated",defaultMessage:"API Token successfully created"}:{id:"notification.success.apitokenedited",defaultMessage:"API Token successfully edited"})}),i?.type&&D(g?"didCreateToken":"didEditToken",{type:i.type,tokenType:G.A})}catch(C){if(C instanceof f.d7&&C.response){const N=(0,as.f)(C.response.data);p.setErrors(N),C?.response?.data?.error?.message===tt?d({type:"warning",message:C.response.data.message||"notification.error.tokennamenotunique"}):d({type:"warning",message:C?.response?.data?.message||"notification.error"})}e()}},[it,ns]=c.useState(!1),lt={...Y,onChange:({target:{value:l}})=>{ns(!0),A({type:"ON_CHANGE",value:l})},onChangeSelectAll:({target:{value:l}})=>{ns(!0),A({type:"SELECT_ALL_IN_PERMISSION",value:l})},setSelectedAction:({target:{value:l}})=>{A({type:"SET_SELECTED_ACTION",value:l})}},es=v&&!g||k&&g;return!g&&!i&&at!=="success"?(0,t.jsx)(Vs,{apiTokenName:i?.name}):(0,t.jsx)(Zs,{value:lt,children:(0,t.jsxs)(K.o,{children:[(0,t.jsx)(r.SL,{name:"API Tokens"}),(0,t.jsx)(F.J9,{validationSchema:bs,validateOnChange:!1,initialValues:{name:i?.name||"",description:i?.description||"",type:i?.type,lifespan:i?.lifespan?i.lifespan.toString():i?.lifespan},enableReinitialize:!0,onSubmit:(l,p)=>ot(l,p),children:({errors:l,handleChange:p,isSubmitting:C,values:N,setFieldValue:_t})=>(it&&N?.type!=="custom"&&_t("type","custom"),(0,t.jsxs)(r.l0,{children:[(0,t.jsx)(y.F,{backUrl:"/settings/api-tokens",title:{id:"Settings.apiTokens.createPage.title",defaultMessage:"Create API Token"},token:i,setToken:U,canEditInputs:es,canRegenerate:X,isSubmitting:C,regenerateUrl:"/admin/api-tokens/"}),(0,t.jsx)(W.D,{children:(0,t.jsxs)(E.k,{direction:"column",alignItems:"stretch",gap:6,children:[Boolean(i?.name)&&(0,t.jsx)(y.c,{token:i?.accessKey,tokenType:G.A}),(0,t.jsx)($s,{errors:l,onChange:p,canEditInputs:es,isCreating:g,values:N,apiToken:i,onDispatch:A,setHasChangedPermissions:ns}),(0,t.jsx)(Js,{disabled:!es||N?.type==="read-only"||N?.type==="full-access"})]})})]}))})]})})},nt=()=>{const n=(0,b.v9)(w.s);return(0,t.jsx)(r.O4,{permissions:n.settings?.["api-tokens"].read,children:(0,t.jsx)(Ms,{})})}}}]);
